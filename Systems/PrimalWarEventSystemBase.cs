using Bloodcraft.Resources;
using Bloodcraft.Services;
using Bloodcraft.Utilities;
using Il2CppInterop.Runtime;
using ProjectM;
using ProjectM.Network;
using ProjectM.Scripting;
using ProjectM.Shared.WarEvents;
using Stunlock.Core;
using System.Collections.Concurrent;
using Unity.Collections;
using Unity.Entities;
using Unity.Mathematics;
using Unity.Transforms;

namespace Bloodcraft.Systems;
public class PrimalWarEventSystem : SystemBase
{
    public static PrimalWarEventSystem Instance { get; set; }
    ServerGameManager _serverGameManager;
    static class Constants
    {
        public const int UNIT_LVL = 10;
        public const int BOSS_LVL = 15;

        public const float LOW_AMP = 1.25f;
        public const float MED_AMP = 1.5f;
        public const float HIGH_AMP = 2f;
        public const float HEALTH_AMP = 3f;
        public const float BUFF_CHANCE = 0.2f;

        // public const float HIGH_FREQ = 0.025f;
        public const float HIGH_FREQ = 0.035f;
        public const float MED_FREQ = 0.0125f;
        public const float LOW_FREQ = 0.00625f;
        public const float EQUAL_WGT = 0.5f;
        public const float BASE_WGT = 0.25f;
        public const float HEAVY_WGT = 0.1f;

        public const float GATE_HEIGHT = 4f;
        public const float RADIUS = 10f;

        public const int MINUTE_SECONDS = 60;
        public const int DAY_SECONDS = 86400;
        public const int DAY_HOURS = 24;
        public const int RIFT_DURATION = 1200;
    }
    struct ActiveRift(RiftHazard hazard, double lifetime)
    {
        public RiftHazard Hazard = hazard;
        public double Lifetime = lifetime;
    }
    readonly struct RiftHazard(PrefabGUID primary, PrefabGUID secondary, float frequency, float weight = Constants.BASE_WGT)
    {
        public readonly PrefabGUID Primary { get; } = primary;
        public readonly PrefabGUID Secondary { get; } = secondary;
        public readonly float Frequency { get; } = frequency;
        public readonly float Weight { get; } = weight;

        static System.Random _random;
        public void TrySpawnHazard(ServerGameManager serverGameManager, float3 position)
        {
            EnsureSeeded(0xC0FFEEu);
            if (_random.NextDouble() < Frequency)
                WeightedThrow(serverGameManager, position);
        }
        void WeightedThrow(ServerGameManager serverGameManager, float3 center)
        {
            PrefabGUID prefabGuid = (_random.NextDouble() < Weight) ? Secondary : Primary;

            float3 pos = center + new float3(
                NextFloat(-Constants.RADIUS, Constants.RADIUS),
                -Constants.GATE_HEIGHT,
                NextFloat(-Constants.RADIUS, Constants.RADIUS)
            );

            Entity spawnedThrow = serverGameManager.InstantiateEntityImmediate(Entity.Null, prefabGuid);
            spawnedThrow.SetPosition(pos);
        }
        static void EnsureSeeded(uint salt = 0)
        {
            if (_random == null)
            {
                var seed = unchecked((int)Misc.GetRandomSeed(salt));
                _random = new System.Random(seed);
            }
        }
        static float NextFloat(float min, float max)
        {
            return min + ((float)_random.NextDouble() * (max - min));
        }

        /*
        static Unity.Mathematics.Random _random;
        public void TrySpawnHazard(ServerGameManager serverGameManager, float3 position)
        {
            EnsureSeeded(0xC0FFEEu);
            if (_random.NextFloat() < Frequency)
                WeightedThrow(serverGameManager, position);
        }
        void WeightedThrow(ServerGameManager serverGameManager, float3 center)
        {
            PrefabGUID prefabGuid = (_random.NextFloat() < Weight) ? Secondary : Primary;
            float3 position = center + new float3(
                _random.NextFloat(-Constants.RADIUS, Constants.RADIUS),
                -Constants.GATE_HEIGHT,
                _random.NextFloat(-Constants.RADIUS, Constants.RADIUS)
            );

            Entity spawnedThrow = serverGameManager.InstantiateEntityImmediate(Entity.Null, prefabGuid);
            spawnedThrow.SetPosition(position);
        }
        static void EnsureSeeded(uint salt = 0)
        {
            if (_random.state == 0)
            {
                var seed = Misc.GetRandomSeed(salt);
                _random = new Unity.Mathematics.Random(seed);
            }
        }
        */
    }

    static readonly ComponentType[] _eventComponents =
    [
        ComponentType.ReadOnly(Il2CppType.Of<WarEvent_StartEvent>()),
        ComponentType.ReadOnly(Il2CppType.Of<FromCharacter>()),
        ComponentType.ReadOnly(Il2CppType.Of<NetworkEventType>())
    ];

    static readonly PrefabGUID _primalGate = PrefabGUIDs.UC_WarEvent_Legion_Bosses_Primal;
    static readonly PrefabGUID _primalPortal = PrefabGUIDs.UC_WarEvent_Legion_Smallwaves_Primal;
    static readonly PrefabGUID _bloodRainBuff = PrefabGUIDs.AB_Dracula_Final_TravelToCenter_Normal_BloodRainBuff;

    static readonly List<PrefabGUID> _variantBuffs =
    [
        PrefabGUIDs.Shared_Affix_LevelAura_Self,
        PrefabGUIDs.AB_CastleMan_HolyBeam_PowerBuff_01,
        PrefabGUIDs.AB_Chaos_PowerSurge_Buff,
        PrefabGUIDs.AB_Bandit_Foreman_BloodRage_Buff
    ];

    readonly List<RiftHazard> _riftHazards = // note to add name field for these
    [
        new(PrefabGUIDs.AB_LightningStorm_Throw,
            PrefabGUIDs.AB_LightningStorm_Throw_Big,
            Constants.HIGH_FREQ,
            Constants.BASE_WGT),
        //new(PrefabGUIDs.AB_Manticore_FrostVortex_Throw,
        //    PrefabGUIDs.AB_ChurchOfLight_Overseer_IceRecovery_Hard_IcicleThrow,
        //    Constants.HIGH_FREQ,
        //    Constants.BASE_WGT),
        //new(PrefabGUIDs.AB_Blackfang_Morgana_SpectralSnake_Far_Throw_02,
        //    PrefabGUIDs.AB_Emery_Erruption_Golem_Throw_Elemental,
        //    Constants.HIGH_FREQ,
        //    Constants.BASE_WGT),
    ];

    static int PrimalRifts { get; } = Math.Min(ConfigService.RiftFrequency, Constants.DAY_HOURS);
    static int RiftInterval { get; } = PrimalRifts > 0
        ? Constants.DAY_SECONDS / PrimalRifts
        : 0;

    static double _nextRiftTime = double.MaxValue;
    static double _lastNotified = -1;

    static bool _isEdited;

    EntityQuery _gateQuery;
    EntityQuery _portalQuery;

    ComponentLookup<VBloodUnit> _vBloodLookup;
    ComponentLookup<Translation> _translationLookup;

    ComponentTypeHandle<WarEvent_ActiveGate> _gateHandle;
    ComponentTypeHandle<WarEvent_ActivePortal> _portalHandle;
    BufferTypeHandle<WarEvent_ActiveUnit> _unitBufferHandle;

    EntityTypeHandle _entityHandle;
    EntityStorageInfoLookup _entityStorageInfoLookup;

    NativeParallelHashSet<Entity> _handled;
    readonly ConcurrentDictionary<Entity, ActiveRift> _activeRifts = [];
    public override void OnCreate()
    {
        Instance = this;

        _gateQuery = GetEntityQuery(new EntityQueryDesc
        {
            All = new[]
            {
                ComponentType.ReadOnly(Il2CppType.Of<WarEvent_ActiveGate>()),
                ComponentType.ReadOnly(Il2CppType.Of<WarEvent_ActiveUnit>())
            },
            Options = EntityQueryOptions.IncludeDisabled
        });

        _portalQuery = GetEntityQuery(new EntityQueryDesc
        {
            All = new[]
            {
                ComponentType.ReadOnly(Il2CppType.Of<WarEvent_ActivePortal>()),
                ComponentType.ReadOnly(Il2CppType.Of<WarEvent_ActiveUnit>())
            },
            Options = EntityQueryOptions.IncludeDisabled
        });

        _vBloodLookup = GetComponentLookup<VBloodUnit>(true);
        _translationLookup = GetComponentLookup<Translation>(true);

        _gateHandle = GetComponentTypeHandle<WarEvent_ActiveGate>(true);
        _portalHandle = GetComponentTypeHandle<WarEvent_ActivePortal>(true);
        _unitBufferHandle = GetBufferTypeHandle<WarEvent_ActiveUnit>(true);

        _entityHandle = GetEntityTypeHandle();
        _entityStorageInfoLookup = GetEntityStorageInfoLookup();

        _handled = new NativeParallelHashSet<Entity>(512, Allocator.Persistent);

        RequireForUpdate(_gateQuery);
        RequireForUpdate(_portalQuery);
        Enabled = true;
    }
    public override void OnStartRunning()
    {
        _serverGameManager = World.GetExistingSystemManaged<ServerScriptMapper>().GetServerGameManager();
        if (!_isEdited)
            _isEdited = TryModifyPrimalUnitCompositions();
    }
    public override void OnUpdate()
    {
        _vBloodLookup.Update(this);
        _translationLookup.Update(this);

        _gateHandle.Update(this);
        _portalHandle.Update(this);
        _unitBufferHandle.Update(this);

        _entityHandle.Update(this);
        _entityStorageInfoLookup.Update(this);

        HandleActiveGates(_gateQuery);
        HandleActivePortals(_portalQuery);

        OnSweep();
    }
    void HandleActiveGates(EntityQuery query)
    {
        var chunks = query.ToArchetypeChunkArray(Allocator.Temp);

        try
        {
            foreach (var chunk in chunks)
            {
                var gates = chunk.GetNativeArray(_gateHandle);
                var unitBuffers = chunk.GetBufferAccessor(_unitBufferHandle);
                var entities = chunk.GetNativeArray(_entityHandle);

                for (int i = 0; i < chunk.Count; ++i)
                {
                    WarEvent_ActiveGate activeGate = gates[i];
                    Entity entity = entities[i];

                    if (!activeGate.UnitComposition.Equals(_primalGate)) continue;

                    var buffer = unitBuffers[i];
                    bool isActive = false;

                    foreach (var activeUnit in buffer)
                    {
                        Entity unitEntity = activeUnit.Instance;
                        bool isGateBoss = _vBloodLookup.HasComponent(unitEntity);

                        if (!_entityStorageInfoLookup.Exists(unitEntity))
                            continue;

                        if (_handled.Contains(unitEntity))
                        {
                            isActive = true;
                            continue;
                        }

                        Core.Delayed(() => unitEntity.TryApplyBuffWithLifeTimeNone(_variantBuffs.DrawRandom())); // blood buffs crash cause lifetime, noting before I forget again >_>
                        ModifyPrimalUnit(unitEntity, isGateBoss);

                        isActive = true;
                        _handled.Add(unitEntity);
                    }

                    if (!isActive
                        || !_translationLookup.TryGetComponent(entity, out Translation translation))
                            continue;

                    if (!_activeRifts.TryGetValue(entity, out ActiveRift activeRift))
                    {
                        activeRift = new(_riftHazards.DrawRandom(), _serverGameManager.ServerTime + Constants.RIFT_DURATION);
                        _activeRifts.TryAdd(entity, activeRift);
                        // Core.Log.LogWarning($"[PrimalWarEventSystem.HandleActiveGates] Adding rift hazard for gate! ({entity} | {_riftHazards.IndexOf(activeRift.Hazard)})");
                    }

                    if (isActive)
                        activeRift.Hazard.TrySpawnHazard(_serverGameManager, translation.Value);
                }
            }
        }
        catch (Exception e)
        {
            Core.Log.LogError($"[PrimalWarEventSystem.HandleActiveGates] Exception: {e}");
        }
        finally
        {
            chunks.Dispose();
        }
    }
    void HandleActivePortals(EntityQuery query)
    {
        var chunks = query.ToArchetypeChunkArray(Allocator.Temp);

        try
        {
            foreach (var chunk in chunks)
            {
                var portals = chunk.GetNativeArray(_portalHandle);
                var unitBuffers = chunk.GetBufferAccessor(_unitBufferHandle);
                var entities = chunk.GetNativeArray(_entityHandle);

                for (int i = 0; i < chunk.Count; ++i)
                {
                    WarEvent_ActivePortal activePortal = portals[i];
                    Entity entity = entities[i];

                    if (!activePortal.UnitComposition.Equals(_primalPortal))
                        continue;

                    // activePortal.MinNormalUnits = 15;
                    // activePortal.ThrashPerNormal = 5;
                    // didn't seem to do anything, may need to add to unit composition numbers first?

                    var buffer = unitBuffers[i];
                    // bool isActive = false;

                    foreach (var activeUnit in buffer)
                    {
                        Entity unitEntity = activeUnit.Instance;

                        if (!_entityStorageInfoLookup.Exists(unitEntity)) continue;
                        else if (_handled.Contains(unitEntity))
                        {
                            // isActive = true;
                            continue;
                        }

                        if (Misc.RollForChance(Constants.BUFF_CHANCE))
                        {
                            Core.Delayed(() => unitEntity.TryApplyBuffWithLifeTimeNone(_variantBuffs.DrawRandom()));
                        }

                        ModifyPrimalUnit(unitEntity);

                        // isActive = true;
                        _handled.Add(unitEntity);
                    }
                }
            }
        }
        catch (Exception e)
        {
            Plugin.LogInstance.LogError($"[PrimalWarEventSystem.HandleActivePortals] Exception: {e}");
        }
        finally
        {
            chunks.Dispose();
        }
    }
    bool TryModifyPrimalUnitCompositions()
    {
        bool wavesModified = false;
        bool soulsModified = false;

        Entity primalWaves = _serverGameManager.GetPrefabEntity(PrefabGUIDs.UC_WarEvent_Legion_Smallwaves_Primal);
        Entity majorWaves = _serverGameManager.GetPrefabEntity(PrefabGUIDs.UC_WarEvent_Legion_Smallwaves_Major);

        Entity primalSouls = _serverGameManager.GetPrefabEntity(PrefabGUIDs.UC_WarEvent_Legion_Bosses_Primal);
        Entity majorSouls = _serverGameManager.GetPrefabEntity(PrefabGUIDs.UC_WarEvent_Legion_Bosses_Major);

        if (_serverGameManager.TryGetBuffer<UnitCompositionGroupEntry>(primalWaves, out var targetBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupUnitEntry>(primalWaves, out var targetUnitBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupEntry>(majorWaves, out var sourceBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupUnitEntry>(majorWaves, out var sourceUnitBuffer))
        {
            targetBuffer.Clear();
            targetBuffer.CopyFrom(sourceBuffer);

            targetUnitBuffer.Clear();
            targetUnitBuffer.CopyFrom(sourceUnitBuffer);

            /*
            for (int i = 0; i < targetBuffer.Length; i++)
            {
                var group = targetBuffer[i];
                group.UnitsCount += 5;
                targetBuffer[i] = group;
            }
            */

            wavesModified = true;
        }

        if (_serverGameManager.TryGetBuffer<UnitCompositionGroupEntry>(primalSouls, out targetBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupUnitEntry>(primalSouls, out targetUnitBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupEntry>(majorSouls, out sourceBuffer)
            && _serverGameManager.TryGetBuffer<UnitCompositionGroupUnitEntry>(majorSouls, out sourceUnitBuffer))
        {
            targetBuffer.Clear();
            targetBuffer.CopyFrom(sourceBuffer);

            targetUnitBuffer.Clear();
            targetUnitBuffer.CopyFrom(sourceUnitBuffer);

            /*
            for (int i = 0; i < targetBuffer.Length; i++)
            {
                var group = targetBuffer[i];
                group.UnitsCount++;
                targetBuffer[i] = group;
            }
            */

            soulsModified = true;
        }

        return wavesModified && soulsModified;
    }
    void OnSweep()
    {
        var units = _handled.ToNativeArray(Allocator.Temp);

        foreach (var unit in units)
        {
            if (!_entityStorageInfoLookup.Exists(unit))
                _handled.Remove(unit);
        }

        units.Dispose();

        foreach (var kvp in _activeRifts)
        {
            if (_serverGameManager.ServerTime >= kvp.Value.Lifetime)
                _activeRifts.TryRemove(kvp.Key, out _);
        }
    }
    public static void OnSchedule()
    {
        if (_nextRiftTime == double.MaxValue)
        {
            _nextRiftTime = Core.ServerGameManager.ServerTime + RiftInterval;

            DateTime utcThen = DateTime.UtcNow.AddSeconds(RiftInterval);
            DateTime localThen = utcThen.ToLocalTime();

            Core.Log.LogWarning($"[PrimalWarEventSystem]: ~It's The Primal Countdown~ ({RiftInterval / Constants.MINUTE_SECONDS}m | {localThen:HH:mm})");
            return;
        }

        double remainingSeconds = _nextRiftTime - Core.ServerGameManager.ServerTime;

        if (remainingSeconds <= 0)
        {
            TryStartPrimalRifts();
            return;
        }

        int remainingMinutes = (int)(remainingSeconds / Constants.MINUTE_SECONDS);

        if (remainingMinutes != RiftInterval / Constants.MINUTE_SECONDS &&
            remainingMinutes % 15 == 0 &&
            remainingMinutes != _lastNotified)
        {
            _lastNotified = remainingMinutes;

            DateTime utcThen = DateTime.UtcNow.AddSeconds(remainingSeconds);
            DateTime localThen = utcThen.ToLocalTime();

            Core.Log.LogWarning($"[PrimalWarEventSystem]: #SoonTM ({remainingMinutes}m | {localThen:HH:mm})");
        }
    }
    public static void TryStartPrimalRifts()
    {
        _nextRiftTime = Core.ServerGameManager.ServerTime + RiftInterval;

        if (!PlayerService.SteamIdOnlinePlayerInfoCache.Any())
            return;

        var player = PlayerService.SteamIdOnlinePlayerInfoCache.Values.FirstOrDefault();

        NetworkEventType networkEventType = new()
        {
            EventId = NetworkEvents.EventId_WarEvent_StartEvent,
            IsAdminEvent = true,
            IsDebugEvent = true
        };

        WarEvent_StartEvent warEvent = new()
        {
            EventType = WarEventType.Primal,
            EnableAllGates = true
        };

        FromCharacter fromCharacter = new()
        {
            Character = player.CharEntity,
            User = player.UserEntity
        };

        Entity entity = Core.EntityManager.CreateEntity(_eventComponents);
        entity.Write(warEvent);
        entity.Write(fromCharacter);
        entity.Write(networkEventType);

        Core.Log.LogWarning($"[PrimalWarEventSystem]: Primal Rifts - Active");
    }
    static void ModifyPrimalUnit(Entity entity, bool isGateBoss = false)
    {
        if (isGateBoss)
            entity.TryApplyBuffWithLifeTimeNone(_bloodRainBuff);

        SetLevel(entity, isGateBoss);
        SetAttackSpeed(entity);
        SetHealth(entity);
        SetPower(entity, isGateBoss);
        SetMoveSpeed(entity);
    }
    static void SetLevel(Entity entity, bool isGateBoss)
    {
        int modifier = isGateBoss ? Constants.BOSS_LVL : Constants.UNIT_LVL;

        entity.With((ref UnitLevel unitLevel) => unitLevel.Level._Value += modifier);
    }
    static void SetAttackSpeed(Entity entity)
    {
        float modifier = entity.IsDreadful() ? Constants.HIGH_AMP : Constants.LOW_AMP;

        entity.With((ref AbilityBar_Shared abilityBarShared) =>
        {
            abilityBarShared.AbilityAttackSpeed._Value *= modifier;
            abilityBarShared.PrimaryAttackSpeed._Value *= modifier;
        });
    }
    static void SetHealth(Entity entity)
    {
        entity.With((ref Health health) =>
        {
            health.MaxHealth._Value *= Constants.HEALTH_AMP;
            health.Value = health.MaxHealth._Value;
        });
    }
    static void SetPower(Entity entity, bool isGateBoss)
    {
        entity.With((ref UnitStats unitStats) =>
        {
            unitStats.PhysicalPower._Value *= Constants.HIGH_AMP;
            unitStats.SpellPower._Value *= Constants.HIGH_AMP;
            unitStats.FireResistance._Value = isGateBoss ? 1 : unitStats.FireResistance._Value;
        });

        if (isGateBoss)
        {
            entity.HasWith((ref ResistanceData resistanceData) =>
            {
                resistanceData.FireResistance_DamageReductionPerRating = 100f;
                resistanceData.FireResistance_RedcuedIgiteChancePerRating = 100f;
            });
        }
    }
    static void SetMoveSpeed(Entity entity)
    {
        entity.With((ref AiMoveSpeeds aiMoveSpeeds) =>
        {
            aiMoveSpeeds.Walk._Value *= Constants.MED_AMP;
            aiMoveSpeeds.Run._Value *= Constants.MED_AMP;
            aiMoveSpeeds.Circle._Value *= Constants.MED_AMP;
        });
    }

    protected override void OnDestroy()
    {
        if (_handled.IsCreated)
        {
            _handled.Dispose();
        }

        _activeRifts.Clear();

        Instance = null;
        _nextRiftTime = double.MaxValue;
        _lastNotified = -1;
        _isEdited = false;

        base.OnDestroy();
    }
}

/*
public static void AddUnitToCompEnd(PrefabGUID prefabGuid)
{
    var unitBuffer = entityManager.GetBuffer<UnitCompositionGroupUnitEntry>(ucEntity);
    var groupBuffer = entityManager.GetBuffer<UnitCompositionGroupEntry>(ucEntity);

    unitBuffer.Add(new UnitCompositionGroupUnitEntry
    {
        Unit = unitGuid,
        IsVBloodUnit = false,
        CustomVBloodUnit = default,
        // UnitBaseStatsType = UnitBaseStatsType.Normal
    });

    var last = groupBuffer.Length--;
    var entry = groupBuffer[last];

    entry.UnitsCount++;
    groupBuffer[last] = entry;
}
*/